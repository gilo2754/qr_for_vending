<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista de QR Codes</title>
    <link rel="stylesheet" href="/static/styles.css">
    <script src="/static/js/utils.js"></script>
    <script src="/static/js/qr-card-component.js"></script>
</head>
<body>
    <div class="container">
        <h1>Lista de QR Codes</h1>
        <button onclick="loadQRCodes()" class="refresh-button">Actualizar Lista</button>
        
        <div class="qr-stats">
            <h3>Estadísticas de QR</h3>
            <div class="stats-container">
                <div class="stat-item">
                    <span class="stat-label">Válidos:</span>
                    <span class="stat-value" id="valid-count">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">En Circulación:</span>
                    <span class="stat-value" id="in-circulation-count">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Usados:</span>
                    <span class="stat-value" id="used-count">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Expirados:</span>
                    <span class="stat-value" id="expired-count">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Invalidados:</span>
                    <span class="stat-value" id="invalidated-count">0</span>
                </div>
                <div class="stat-item stat-total">
                    <span class="stat-label">Total:</span>
                    <span class="stat-value" id="total-count">0</span>
                </div>
            </div>
        </div>

        <div id="loading">Cargando códigos QR...</div>
        <div id="error" class="error-message"></div>
        <div id="qrList" class="qr-list"></div>
    </div>

    <script>
        // Obtener la URL base de la API
        const API_URL = window.location.origin;

        // Función para obtener el token de autenticación
        function getAuthToken() {
            return localStorage.getItem('access_token');
        }

        // Función para cargar los códigos QR
        async function loadQRCodes() {
            const loadingElement = document.getElementById('loading');
            const errorElement = document.getElementById('error');
            const qrListElement = document.getElementById('qrList');

            // Mostrar mensaje de carga
            loadingElement.style.display = 'block';
            errorElement.style.display = 'none';
            qrListElement.innerHTML = '';

            try {
                // Cargar los códigos QR
                const response = await fetch(`${API_URL}/api/qrcodes`, {
                    headers: {
                        'Authorization': `Bearer ${getAuthToken()}`
                    }
                });
                if (!response.ok) {
                    throw new Error(`Error al cargar los códigos QR: ${response.status}`);
                }
                const qrCodes = await response.json();

                // Actualizar contadores
                const stats = {
                    valido: 0,
                    enCirculacion: 0,
                    usado: 0,
                    expirado: 0,
                    invalidado: 0,
                    total: qrCodes.length
                };

                qrCodes.forEach(qr => {
                    // Incrementar el contador correspondiente
                    if (stats.hasOwnProperty(qr.state)) {
                        stats[qr.state]++;
                    } else {
                        console.warn(`Estado desconocido: ${qr.state}`);
                    }
                });

                // Actualizar los valores en el DOM
                document.getElementById('valid-count').textContent = stats.valido;
                document.getElementById('in-circulation-count').textContent = stats.enCirculacion;
                document.getElementById('used-count').textContent = stats.usado;
                document.getElementById('expired-count').textContent = stats.expirado;
                document.getElementById('invalidated-count').textContent = stats.invalidado;
                document.getElementById('total-count').textContent = stats.total;

                // Mostrar la lista de códigos QR usando el componente
                qrCodes.forEach(qr => {
                    const qrCard = QRCardComponent.createCard({
                        qrcode_id: qr.qrcode_id,
                        value: qr.value,
                        state: qr.state,
                        creation_date: qr.creation_date,
                        used_date: qr.used_date,
                        qr_image: qr.qr_image
                    });
                    qrListElement.appendChild(qrCard);
                });

                loadingElement.style.display = 'none';
            } catch (error) {
                console.error('Error:', error);
                errorElement.textContent = error.message;
                errorElement.style.display = 'block';
                loadingElement.style.display = 'none';
            }
        }

        // Verificar autenticación al cargar la página
        function checkAuth() {
            const token = localStorage.getItem('access_token');
            if (!token) {
                window.location.href = '/login.html';
            }
        }

        // Cargar los códigos QR al cargar la página
        document.addEventListener('DOMContentLoaded', () => {
            checkAuth();
            loadQRCodes();
        });
    </script>
</body>
</html> 